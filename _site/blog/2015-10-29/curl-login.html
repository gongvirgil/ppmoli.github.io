<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>curl模拟登陆 | site of gongvirgil</title>
    <meta name="author" content="gongvirgil" />
    <meta name="renderer" content="webkit">
    <meta name="description" content="gongvirgil's Blog" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="shortcut icon" href="/public/images/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/atom.xml" />
    <link rel="stylesheet" href="/public/font-awesome-4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/public/css/default.css">
    <link rel="stylesheet" href="/public/scroll/jquery.mCustomScrollbar.css">
    <script type="text/javascript" src="/public/js/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="/public/scroll/jquery.mCustomScrollbar.concat.min.js"></script>
    <script type="text/javascript" src="/public/js/default.js"></script>
  </head>
  <body>
    <!--Header-->
    <header class="header">
      <div class="avatar">
        <img width="80" height="80" src="/public/images/me.png" class="circle">
        <a title="Virgil's Blog" href="/"><h2>Virgil's Blog</h2></a>
      </div>   
      <div class="links">
        <a title="返回主页" href="/"><i class="fa fa-home"></i></a>
        <a title="github" href="https://github.com/gongvirgil" target="_blank"><i class="fa fa-github"></i></a>
        <a title="weibo" href="http://weibo.com/ppmoli" target="_blank"><i class="fa fa-weibo"></i></a>
        <a title="返回主页" href="/" target="_blank"><i class="fa fa-home"></i></a>
        <a title="返回主页" href="/" target="_blank"><i class="fa fa-home"></i></a>
      </div> 
      <div class="calculates">  
        <div class="calculate-item">
          <a href="/"><span class="calculate-item-count"><i class="fa fa-home"></i></span><span class="calculate-item-name">首页</span></a>
        </div>
        <div class="calculate-item">
          <a href="/archive.html"><span class="calculate-item-count">36</span><span class="calculate-item-name">归档</span></a>
        </div>
        <div class="calculate-item">
          <a href="/category.html"><span class="calculate-item-count">4</span><span class="calculate-item-name">分类</span></a>
        </div>
        <div class="calculate-item">
          <a href="/tag.html"><span class="calculate-item-count">48</span><span class="calculate-item-name">标签</span></a>
        </div>
      </div>
    </header>
    <!--Header End-->
    <!--Sidebar-->
    <div class="sidebar">
              <div id="menu-pages">
          <li><a href="/">HOME</a></li>
          <li><a href="/archive.html">ALL POSTS</a></li>
          <li><a href="/contact.html">CONTACT ME</a></li>
        </div>
        <div id="search">
          <input value="站内搜索" name="search">
        </div>
        <div id="category">
            <h4>CATEGORY</h4>
            <div class="list-content">
              
              <li><a href="/category.html?CATE=技术">技术<span class="cate-size">25</span></a></li>
              
              <li><a href="/category.html?CATE=生活">生活<span class="cate-size">1</span></a></li>
              
              <li><a href="/category.html?CATE=随笔">随笔<span class="cate-size">3</span></a></li>
              
              <li><a href="/category.html?CATE=资源">资源<span class="cate-size">1</span></a></li>
              
            </div>
            <div class="clear"></div>
        </div>
        <div id="tag">
            <h4>TAGS</h4>
            <div  class="tag-cloud">
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=html" title="1" style="font-size: 9.5pt; color: #999;">html</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=笔记" title="12" style="font-size: 12pt; color: #666;">笔记</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=jquery" title="1" style="font-size: 9.5pt; color: #999;">jquery</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=js" title="1" style="font-size: 9.5pt; color: #999;">js</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=Linux" title="1" style="font-size: 9.5pt; color: #999;">Linux</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=php" title="2" style="font-size: 9.5pt; color: #888;">php</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=css" title="2" style="font-size: 9.5pt; color: #888;">css</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=软件" title="2" style="font-size: 9.5pt; color: #888;">软件</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=Github" title="1" style="font-size: 9.5pt; color: #999;">Github</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=Blog" title="2" style="font-size: 9.5pt; color: #888;">Blog</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=Jekyll" title="1" style="font-size: 9.5pt; color: #999;">Jekyll</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=markdown" title="1" style="font-size: 9.5pt; color: #999;">markdown</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=page" title="1" style="font-size: 9.5pt; color: #999;">page</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=CSS" title="2" style="font-size: 9.5pt; color: #888;">CSS</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=sublime" title="1" style="font-size: 9.5pt; color: #999;">sublime</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=work" title="1" style="font-size: 9.5pt; color: #999;">work</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=code" title="1" style="font-size: 9.5pt; color: #999;">code</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=soft" title="1" style="font-size: 9.5pt; color: #999;">soft</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=购物" title="1" style="font-size: 9.5pt; color: #999;">购物</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=品牌" title="1" style="font-size: 9.5pt; color: #999;">品牌</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=日用品" title="1" style="font-size: 9.5pt; color: #999;">日用品</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=ThinkPHP" title="1" style="font-size: 9.5pt; color: #999;">ThinkPHP</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=linux" title="5" style="font-size: 10.5pt; color: #888;">linux</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=bootstrap" title="1" style="font-size: 9.5pt; color: #999;">bootstrap</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=vi" title="1" style="font-size: 9.5pt; color: #999;">vi</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=git" title="1" style="font-size: 9.5pt; color: #999;">git</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=laravel" title="2" style="font-size: 9.5pt; color: #888;">laravel</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=随笔" title="2" style="font-size: 9.5pt; color: #888;">随笔</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=任务" title="1" style="font-size: 9.5pt; color: #999;">任务</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=PHPExcel" title="1" style="font-size: 9.5pt; color: #999;">PHPExcel</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=Excel" title="1" style="font-size: 9.5pt; color: #999;">Excel</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=PHP" title="3" style="font-size: 10pt; color: #888;">PHP</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=单例模式" title="1" style="font-size: 9.5pt; color: #999;">单例模式</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=firefox" title="1" style="font-size: 9.5pt; color: #999;">firefox</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=插件" title="1" style="font-size: 9.5pt; color: #999;">插件</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=域名" title="1" style="font-size: 9.5pt; color: #999;">域名</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=重定向" title="1" style="font-size: 9.5pt; color: #999;">重定向</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=函数" title="1" style="font-size: 9.5pt; color: #999;">函数</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=mobile" title="1" style="font-size: 9.5pt; color: #999;">mobile</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=jQuery" title="1" style="font-size: 9.5pt; color: #999;">jQuery</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=英语" title="1" style="font-size: 9.5pt; color: #999;">英语</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=生词本" title="1" style="font-size: 9.5pt; color: #999;">生词本</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=安装" title="1" style="font-size: 9.5pt; color: #999;">安装</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=curl" title="1" style="font-size: 9.5pt; color: #999;">curl</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=API" title="1" style="font-size: 9.5pt; color: #999;">API</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=接口" title="1" style="font-size: 9.5pt; color: #999;">接口</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=国家" title="1" style="font-size: 9.5pt; color: #999;">国家</a>
                
                  
                  
                  
                  
                    
                  
                  
                    
                  
                  <a href="/tag.html?TAG=小知识" title="1" style="font-size: 9.5pt; color: #999;">小知识</a>
                
            </div>
            <div class="clear"></div>
        </div>



    </div>
    <!--Sidebar End-->
    <!--Main-->
    <div class="main">
      <div class="main-content">
            <link rel="stylesheet" type="text/css" href="/public/css/post.css">
    <link rel="stylesheet" type="text/css" href="/public/css/prettify.css">
    <!-- <link rel="stylesheet" type="text/css" href="/public/css/poole.css"> -->
    <div class="post-main">
        <div id="content">
            <div class="post">
                <div class="post_title">
                    <h1>curl模拟登陆</h1>
                </div>
                <div class="post_relate">
                    <span class="post_date">2015-10-29</span>
                    <span class="post_categories">技术</span>
                    <span class="post_tags">
                        
                            <a href="/tag.html?TAG=php" title="php">#php</a>
                        
                            <a href="/tag.html?TAG=curl" title="curl">#curl</a>
                        
                    </span>
                </div>
                <div class="post_content">
                    <p>用PHP开发模拟浏览器的应用,首选技术是CURL函数库。但是php官方提供的技术文档资料很少，相关的示例代码也很少。</p>

<p>最 近由于项目需要，开发了一系列免费邮箱的导出用户自己联系人的功能，包括国内外知名邮 箱，163，sina，sohu,yahoo,hotmail,gmail,qq mail等。还开发了一些方便用户嵌入代码到各大博客，个人门户的应用。比如嵌入flash代码到Qzone，网易的blog，百度的个人门户等。</p>

<p>当然，最原始的技术手段是采用fsockopen函数，然后深入去学习http协议，写出标准的http头信息，也是可以完成开发的。不过麻烦的地方就出在标准。如果对http协议标准认识不深，经常会因碰到少了一个空格或者少了一个换行符号而debug很久。</p>

<p>OK， 还是进入正题。工欲善其事，必先利其器。要模拟浏览器访问网站，首选要学会观察浏览器是如何发送http报文的，以及网站服务器返回给浏览器 是什么样的内容。我推荐安装一个国外人开发的httpwatch的软件，最好搞个破解的版本，否则有些功能是使用不了的。这个软件安装完成之后是嵌入在 IE里的，启动Record，在地址栏输入网址后回车，它就会将浏览器和服务器之间的所有通讯扫描出来，让你一览无遗。关于这个软件的使用在本文不做介 绍。</p>

<p>模拟浏览器登陆应用开发，最关键的地方是突破登陆验证。CURL技术不只支持http，还支持https。区别就在多了一层SSL加密传输。如果是要登陆 https网站，php记得要支持openssl。还是先拿一个例子来分析。</p>

<pre><code>// 用户名
$login = ‘username’;
//密码
$password = ‘password’;

//163的用户登陆地址
$url = “https://reg.163.com/logins.jsp”;

//post 要提交的数据
$fields = “verifycookie=1&amp;style=16&amp;product=mail163&amp;username=”.$login.”&amp;password=”.$password.”&amp;selType=jy&amp;remUser=&amp;secure=on&amp;%B5%C7%C2%BC%D3%CA%CF%E4=%B5%C7%C2%BC%D3%CA%CF%E4″;

// 用来存放cookie的文件
$cookie_file = dirname(__FILE__).”/cookie.txt”;

// 启动一个CURL会话
$ch = curl_init();

// 要访问的地址
curl_setopt($ch, CURLOPT_URL, $url);

// 对认证证书来源的检查，0表示阻止对证书的合法性的检查。
curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);

// 从证书中检查SSL加密算法是否存在
curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);

//模拟用户使用的浏览器，在HTTP请求中包含一个”user-agent”头的字符串。
curl_setopt($ch, CURLOPT_USERAGENT, “Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)”);

// 发送一个常规的POST请求，类型为：application/x-www-form-urlencoded，就像表单提交的一样。
curl_setopt($ch, CURLOPT_POST, 1);

//要传送的所有数据，如果要传送一个文件，需要一个@开头的文件名
curl_setopt($ch, CURLOPT_POSTFIELDS, $fields);

//连接关闭以后，存放cookie信息的文件名称
curl_setopt($ch, CURLOPT_COOKIEJAR, $cookie_file);

// 包含cookie信息的文件名称，这个cookie文件可以是Netscape格式或者HTTP风格的header信息。
curl_setopt($ch, CURLOPT_COOKIEFILE, $cookie_file);

// 设置curl允许执行的最长秒数
//curl_setopt($ch, CURLOPT_TIMEOUT, 6);

// 获取的信息以文件流的形式返回，而不是直接输出。
curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);

// 执行操作
$result = curl_exec($ch);

if ($result == NULL) {
echo “Error:
“;
echo curl_errno($ch) . ” – ” . curl_error($ch) . ”
“;
}

// 关闭CURL会话
curl_close($ch); 
</code></pre>
            
                </div>
            </div>
            <div class="pre-next">
            <li class="pre"><i class="fa fa-angle-left"></i><a href="/blog/2015-10-27/msvcr100u-dll.html">如何解决msvcr100.dll丢失问题</a></a></li>
                <li class="next"><a href="/blog/2015-11-02/all-api.html">各种API</a><i class="fa fa-angle-right"></i></li>
            </div>
            <!-- 多说评论框 start -->
            <div class="ds-thread" data-thread-key="/blog/2015-10-29/curl-login" data-title="curl模拟登陆" data-url="/blog/2015-10-29/curl-login.html"></div>
            <!-- 多说评论框 end -->
        </div>
    </div>
    <div class="post-anchor">
        <div id="BlogAnchor">
            <h4>目录<a id="AnchorContentToggle" title="展开" style="cursor:pointer;">[<span>+</span>]</a></h4>
            <div class="AnchorContent" id="AnchorContent"></div>
        </div> 
    </div>
    <div style="clear:both;"></div>
    <script type="text/javascript" src="/public/js/post.js"></script>

    
      </div>
      <!--Footer-->
      <div class="footer">
        <div class="footer-inner">
    <div class="footer_info">
        <div class="friendly-links">
            <span>友好链接</span>
        </div>
        <div class="site-info">
          <p>Copyright © 2012-2015 gongvirgil.github.io <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1256615808'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1256615808%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));</script></p>
        </div>
    </div>      
    <div class="tj"></div>
</div>
      </div>
      <!--Footer End-->
    </div>
    <!--Main End-->
    <script>
    $(function(){
      $("#sitebar-toggle-btn").click(function(event) {
        if($(this).hasClass('active')){
          $(".sidebar").fadeOut('50000');
          $(".main").animate({marginLeft: $(window).width()>650?"33.3%":"0px"},1000,function(){
            $(".header").fadeIn('500');
          });
          $(this).removeClass('active');
          $(this).html('<i class="fa fa-navicon"></i>');
        }else{
          $(".header").fadeOut('50000');
          $(".main").animate({marginLeft: "0px"},1000,function(){
            $(".sidebar").fadeIn('500');
          });
          $(this).addClass('active');
          $(this).html('<i class="fa fa-close"></i>');
        }
      });
    })
    </script>
    <!--Float Btns-->
    <div class="sitebar-toggle">
      <a id="sitebar-toggle-btn"><i class="fa fa-navicon"></i></a>
    </div>
    <div class="goTop" >
      <a title="回到顶部" id="goTop_btn"><i class="fa fa-chevron-up"></i></a>
    </div>
    <!--Float Btns End-->
    <!-- 多说js加载开始，一个页面只需要加载一次 -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"gongvirgil"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
  </body>
</html>
